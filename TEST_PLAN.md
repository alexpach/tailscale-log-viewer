# Test Plan for ts-logs

## Overview
This document outlines the testing strategy for the ts-logs Tailscale network logging utility.

## Test Categories

### 1. Unit Tests

#### Numeric Validation Tests (`test/test_numeric_validation.sh`)
- **Purpose**: Validate that time range parameters only accept positive integers
- **Coverage**:
  - Negative values (should reject)
  - Zero values (should reject)
  - Decimal values (should reject)
  - Non-numeric values (should reject)
  - Leading zeros (should reject)
  - Valid positive integers (should accept)
- **Special Features**: Uses `--use-test-data` to avoid API calls

#### CSV Output Tests (`test/test_csv_output.sh`)
- **Purpose**: Verify CSV format output functionality
- **Coverage**:
  - CSV header generation
  - Correct column count (9 columns)
  - Data row consistency
  - Filter compatibility with CSV format
  - File redirection capability

#### New Features Tests (`test/test_new_features.sh`)
- **Purpose**: Test recently added features
- **Coverage**:
  - Debug mode (`--debug`)
  - Statistics mode (`--stats`)
  - Exclusion filters (`--exclude-src`, `--exclude-dst`)
  - IP masking (`--mask-ips`)
  - Combined feature usage
  - Help text completeness
  - Test data generator functionality

### 2. Integration Tests

#### Test Data Generation
- **Command**: `./ts-logs --generate-test-data`
- **Purpose**: Create realistic test data for offline testing
- **Output**: `examples/test-data-YYYYMMDD.json`
- **Contents**:
  - 50 log entries with various traffic types
  - Device information for name resolution
  - Properly formatted JSON structure

#### Test Data Usage
- **Command**: `./ts-logs --use-test-data [options]`
- **Purpose**: Use cached test data instead of making API calls
- **Benefits**:
  - Avoid API rate limits during testing
  - Consistent test results
  - No network dependency for tests
  - Prevent timeouts with large data requests

### 3. Manual Testing Checklist

#### Basic Functionality
- [ ] Help text displays when no arguments provided
- [ ] All time range options work (`-m`, `-H`, `-d`, `--since`, `--until`)
- [ ] All output formats work (table, compact, json, raw, csv, summary)
- [ ] Traffic type filtering works (virtual, subnet, exit, physical)

#### Machine Name Resolution
- [ ] Tailscale IPs (100.x.x.x) resolve to machine names
- [ ] IPv6 addresses are handled correctly
- [ ] Fallback to IP when name resolution fails

#### Filtering
- [ ] Source filtering (`-S`) works with names, IPs, and partial matches
- [ ] Destination filtering (`-D`) works correctly
- [ ] Exclusion filters (`--exclude-src`, `--exclude-dst`) work
- [ ] Combined filters work together

#### Error Handling
- [ ] Invalid time range values are rejected with clear error messages
- [ ] Missing configuration shows helpful guidance
- [ ] API errors are reported clearly (401, 403, 429, 404)
- [ ] Network failures are handled gracefully

#### Performance
- [ ] Large datasets are processed efficiently
- [ ] Streaming output works for real-time display
- [ ] Test data generation completes quickly
- [ ] Test data loading is fast

## Test Execution

### Running All Tests
```bash
# Generate test data first (if needed)
./ts-logs --generate-test-data

# Run all test scripts
for test in test/*.sh; do
    echo "Running $test..."
    $test
done
```

### Running Individual Test Suites
```bash
# Numeric validation tests
./test/test_numeric_validation.sh

# CSV output tests
./test/test_csv_output.sh

# New features tests
./test/test_new_features.sh
```

### Testing with Real Data
```bash
# Test with real API (requires configuration)
./ts-logs -m 5

# Test with cached test data (no API needed)
./ts-logs --use-test-data -m 5
```

## Test Data Management

### Generating Test Data
Test data is automatically generated by test scripts if not present. Manual generation:
```bash
./ts-logs --generate-test-data
```

### Test Data Location
- Test data files: `examples/test-data-YYYYMMDD.json`
- Contains both logs and devices data
- Date-stamped for daily freshness

### Test Data Structure
```json
{
  "logs": [
    {
      "start": "timestamp",
      "end": "timestamp",
      "nodeId": "nodeXXX",
      "virtualTraffic": [...],
      "subnetTraffic": [...],
      "exitTraffic": [...],
      "physicalTraffic": [...]
    }
  ]
}
```

## Continuous Integration

### Pre-commit Checks
1. Run shellcheck for syntax validation
2. Run shfmt for formatting consistency
3. Execute unit tests with test data

### Post-merge Tests
1. Full test suite execution
2. Performance benchmarks (if applicable)
3. Integration tests with mock API

## Known Limitations

1. Tests requiring real API access are skipped by default
2. Some tests may timeout if API is slow
3. Test data needs daily regeneration for date-based tests
4. Platform-specific tests (macOS vs Linux) may vary

## Future Improvements

1. Add mock API server for complete offline testing
2. Implement performance regression tests
3. Add code coverage reporting
4. Create automated test result reporting
5. Add stress testing with large datasets